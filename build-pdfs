#!/bin/bash
set -euo pipefail

DOCS_DIR="$(cd "$(dirname "$0")" && pwd)"
PDF_DIR="$DOCS_DIR/pdf"

# basictex lives here on macOS
export PATH="/usr/local/texlive/2025basic/bin/universal-darwin:$PATH"

mkdir -p "$PDF_DIR"

PANDOC_OPTS=(
  --pdf-engine=xelatex
  -V geometry:margin=1in
  -V colorlinks=true
  -V linkcolor=blue
  -V urlcolor=blue
  -V documentclass=article
  -V fontsize=11pt
  -V mainfont="Helvetica Neue"
  -V sansfont="Helvetica Neue"
  -V monofont="Menlo"
)

count=0
skipped=0
errors=0
force=0

if [ "${1:-}" = "--force" ] || [ "${1:-}" = "-f" ]; then
  force=1
fi

convert_file() {
  local md_file="$1"
  local rel_path="${md_file#$DOCS_DIR/}"
  local pdf_name
  pdf_name="$(echo "$rel_path" | sed 's|/|--|g' | sed 's|\.md$|.pdf|')"
  local pdf_file="$PDF_DIR/$pdf_name"
  local resource_dir
  resource_dir="$(dirname "$md_file")"

  # Skip if PDF exists and is newer than the markdown source
  if [ "$force" -eq 0 ] && [ -f "$pdf_file" ] && [ "$pdf_file" -nt "$md_file" ]; then
    skipped=$((skipped + 1))
    return
  fi

  printf "  %-50s â†’ %s\n" "$rel_path" "$pdf_name"
  if pandoc "$md_file" -o "$pdf_file" \
    --resource-path="$resource_dir:$DOCS_DIR" \
    "${PANDOC_OPTS[@]}" 2>/dev/null; then
    count=$((count + 1))
  else
    echo "    FAILED: $rel_path"
    errors=$((errors + 1))
  fi
}

echo "Building PDFs...$([ "$force" -eq 1 ] && echo ' (forced rebuild)')"
echo ""

# Auto-discover all .md files, skip DOCS-REWRITE-PLAN.md
while IFS= read -r f; do
  convert_file "$f"
done < <(find "$DOCS_DIR" -name "*.md" -not -path "*/pdf/*" -not -name "DOCS-REWRITE-PLAN.md" | sort)

echo ""
echo "Done: $count built, $skipped unchanged, $errors failures"
echo "Output: $PDF_DIR/"
