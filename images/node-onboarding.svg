<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 860 420" font-family="Arial, Helvetica, sans-serif">
  <defs>
    <marker id="aw" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#555"/></marker>
  </defs>

  <!-- Title -->
  <text x="430" y="30" text-anchor="middle" font-size="18" font-weight="bold" fill="#333">Node Onboarding Flow</text>
  <text x="430" y="50" text-anchor="middle" font-size="11" fill="#888">From registration token to connected node</text>

  <!-- Swim lanes -->
  <!-- Admin lane -->
  <rect x="20" y="65" width="820" height="80" rx="0" fill="#EBF2FA" stroke="none"/>
  <text x="40" y="85" font-size="11" font-weight="bold" fill="#4A90D9">ADMIN</text>
  <text x="40" y="98" font-size="9" fill="#4A90D9">(UI or CLI)</text>

  <!-- Server lane -->
  <rect x="20" y="145" width="820" height="80" rx="0" fill="#F0FAF0" stroke="none"/>
  <text x="40" y="170" font-size="11" font-weight="bold" fill="#5CB85C">SERVER</text>
  <text x="40" y="183" font-size="9" fill="#5CB85C">(cvlan-api)</text>

  <!-- Node lane -->
  <rect x="20" y="225" width="820" height="80" rx="0" fill="#FFF8E1" stroke="none"/>
  <text x="40" y="250" font-size="11" font-weight="bold" fill="#E09C3E">NODE</text>
  <text x="40" y="263" font-size="9" fill="#E09C3E">(cvlan-ctrl)</text>

  <!-- Step 1: Admin creates token -->
  <rect x="130" y="75" width="130" height="55" rx="8" fill="#4A90D9" stroke="#3A7BC8" stroke-width="1.5"/>
  <text x="195" y="98" text-anchor="middle" font-size="10" font-weight="bold" fill="white">1. Create Token</text>
  <text x="195" y="115" text-anchor="middle" font-size="9" fill="#D4E6F9">select CVLAN + uses</text>

  <!-- Step 1b: Admin shares token -->
  <rect x="290" y="75" width="130" height="55" rx="8" fill="#4A90D9" stroke="#3A7BC8" stroke-width="1.5"/>
  <text x="355" y="98" text-anchor="middle" font-size="10" font-weight="bold" fill="white">2. Share Token</text>
  <text x="355" y="115" text-anchor="middle" font-size="9" fill="#D4E6F9">out-of-band</text>

  <line x1="260" y1="103" x2="285" y2="103" stroke="white" stroke-width="1.5" marker-end="url(#aw)"/>

  <!-- Arrow down to node -->
  <line x1="355" y1="130" x2="355" y2="175" stroke="#555" stroke-width="1" stroke-dasharray="4,3"/>
  <line x1="355" y1="185" x2="355" y2="240" stroke="#555" stroke-width="1" stroke-dasharray="4,3"/>

  <!-- Step 3: Node discovers -->
  <rect x="130" y="238" width="130" height="55" rx="8" fill="#F0AD4E" stroke="#E09C3E" stroke-width="1.5"/>
  <text x="195" y="261" text-anchor="middle" font-size="10" font-weight="bold" fill="white">3. Discover</text>
  <text x="195" y="278" text-anchor="middle" font-size="9" fill="white">GET /client/discover</text>

  <!-- Arrow up to server -->
  <line x1="195" y1="238" x2="195" y2="200" stroke="#5CB85C" stroke-width="1.5" marker-end="url(#aw)"/>

  <!-- Server discover response -->
  <rect x="130" y="155" width="130" height="55" rx="8" fill="#5CB85C" stroke="#4CAE4C" stroke-width="1.5"/>
  <text x="195" y="178" text-anchor="middle" font-size="10" font-weight="bold" fill="white">Controller URL</text>
  <text x="195" y="195" text-anchor="middle" font-size="9" fill="#D4F0D4">returns API endpoint</text>

  <!-- Step 4: Node registers -->
  <rect x="440" y="238" width="130" height="55" rx="8" fill="#F0AD4E" stroke="#E09C3E" stroke-width="1.5"/>
  <text x="505" y="261" text-anchor="middle" font-size="10" font-weight="bold" fill="white">4. Register</text>
  <text x="505" y="278" text-anchor="middle" font-size="9" fill="white">token + WG pubkey</text>

  <line x1="260" y1="265" x2="435" y2="265" stroke="#E09C3E" stroke-width="1.5" marker-end="url(#aw)"/>

  <!-- Arrow up to server -->
  <line x1="505" y1="238" x2="505" y2="200" stroke="#5CB85C" stroke-width="1.5" marker-end="url(#aw)"/>

  <!-- Server register response -->
  <rect x="430" y="155" width="150" height="55" rx="8" fill="#5CB85C" stroke="#4CAE4C" stroke-width="1.5"/>
  <text x="505" y="175" text-anchor="middle" font-size="10" font-weight="bold" fill="white">Verify + Assign</text>
  <text x="505" y="192" text-anchor="middle" font-size="9" fill="#D4F0D4">cert + IP + CVLAN + peers</text>

  <!-- Step 5: Poll loop -->
  <rect x="610" y="238" width="130" height="55" rx="8" fill="#F0AD4E" stroke="#E09C3E" stroke-width="1.5"/>
  <text x="675" y="261" text-anchor="middle" font-size="10" font-weight="bold" fill="white">5. Poll Loop</text>
  <text x="675" y="278" text-anchor="middle" font-size="9" fill="white">mTLS, 60s intervals</text>

  <line x1="570" y1="265" x2="605" y2="265" stroke="#E09C3E" stroke-width="1.5" marker-end="url(#aw)"/>

  <!-- Arrow up to server -->
  <line x1="675" y1="238" x2="675" y2="200" stroke="#5CB85C" stroke-width="1.5" marker-end="url(#aw)"/>

  <!-- Server poll response -->
  <rect x="620" y="155" width="130" height="55" rx="8" fill="#5CB85C" stroke="#4CAE4C" stroke-width="1.5"/>
  <text x="685" y="175" text-anchor="middle" font-size="10" font-weight="bold" fill="white">Delta Updates</text>
  <text x="685" y="192" text-anchor="middle" font-size="9" fill="#D4F0D4">peer changes, policies</text>

  <!-- Self-loop on poll -->
  <path d="M 740 265 Q 770 265 770 240 Q 770 220 740 250" fill="none" stroke="#E09C3E" stroke-width="1" stroke-dasharray="3,2"/>
  <text x="785" y="250" font-size="8" fill="#E09C3E">repeat</text>

  <!-- Result box -->
  <rect x="130" y="325" width="710" height="80" rx="8" fill="white" stroke="#5CB85C" stroke-width="2"/>
  <text x="485" y="350" text-anchor="middle" font-size="13" font-weight="bold" fill="#5CB85C">Connected Node</text>

  <rect x="150" y="360" width="110" height="30" rx="4" fill="#F0FAF0" stroke="#5CB85C" stroke-width="1"/>
  <text x="205" y="380" text-anchor="middle" font-size="9" fill="#5CB85C">mTLS Certificate</text>

  <rect x="275" y="360" width="110" height="30" rx="4" fill="#F0FAF0" stroke="#5CB85C" stroke-width="1"/>
  <text x="330" y="380" text-anchor="middle" font-size="9" fill="#5CB85C">Assigned IP</text>

  <rect x="400" y="360" width="110" height="30" rx="4" fill="#F0FAF0" stroke="#5CB85C" stroke-width="1"/>
  <text x="455" y="380" text-anchor="middle" font-size="9" fill="#5CB85C">CVLAN Membership</text>

  <rect x="525" y="360" width="110" height="30" rx="4" fill="#F0FAF0" stroke="#5CB85C" stroke-width="1"/>
  <text x="580" y="380" text-anchor="middle" font-size="9" fill="#5CB85C">Peer List</text>

  <rect x="650" y="360" width="110" height="30" rx="4" fill="#F0FAF0" stroke="#5CB85C" stroke-width="1"/>
  <text x="705" y="380" text-anchor="middle" font-size="9" fill="#5CB85C">WG Tunnel Keys</text>

  <!-- Arrows down to result -->
  <line x1="675" y1="293" x2="485" y2="320" stroke="#5CB85C" stroke-width="1.5" marker-end="url(#aw)"/>
</svg>
